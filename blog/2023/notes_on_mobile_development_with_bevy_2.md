---
title: "Notes on mobile development with Bevy #2"
date: 2023-08-03
category: code
summary: "A collection of learnings and solutions for mobile development with Bevy. Among others, contains notes on how to get an Android App Bundle and hot to prepare your Android and iOS builds for the stores."
tags:
- gamedev
- rust
- bevy
- ios
- automation
- ci/cd
---

My [Bevy][bevy] mobile app is very incomplete, but I would like to be able to distribute test builds early on. That means Android builds need to be acceptable for the Play Store and iOS builds need to pass Apple's bar for the App Store. On the way to that goal, there are a couple technical issues to solve and some configuration to do in App Store Connect and Google Play Console. I will concentrate on the technical challenges while mentioning some store configurations.

Most of this effort did not directly go into my current app project. I decided to add iOS and Android support to [`bevy_game_template`][bevy_game_template] first. This way, the community might benefit more from my work and I can just copy the setup for other projects.

The starting point of this post is the [mobile example][mobile_example] from Bevy with small adjustments discussed in a [previous post][bevy-mobile-1].

## Android

### Getting an Android App Bundle

The cargo-apk setup from Bevy's mobile example allows us to build APK files. The Play Store no longer accepts APKs, but [requires app bundles][app-bundles-only]. This makes sense to keep downloads small and still support multiple device ABIs ([**A**pplication **B**inary **I**nterface][abi-wiki]), but it requires some extra work to get an app bundle for a Bevy game.

The only tool I could convince to create an app bundle from my Bevy project is [xbuild][xbuild], the WIP successor of cargo-apk[^1]. We can configure xbuild to bundle our project for Android with the following `manifest.yaml`

```yaml
android:
  gradle: true
  icon: "your_icon.png"
  manifest:
    package: "com.example.bevygame"
    version_code: 1
    application:
      label: "Bevy game"
```

Currently, xbuild decides to create app bundles only when using `yaml$gradle: true` and only for production builds. Running `x build --platform android --store play` creates an app bundle, but derived APKs instantly crash.

> I had to do a couple changes to get xbuild to create working app bundles. Some of them might get upstreamed, but a few are obvious hacks that only work for the Bevy project structure (like a single, hardcoded `assets` directory). For the xcode commands in this post to work as expected, you need to install xbuild from my fork: `bash$cargo install --git https://github.com/NiklasEi/xbuild`.

### libc++ shared is missing

Looking at the logs with `adb logcat` while trying to start the app on my phone yields the following error:
```log
java.lang.UnsatisfiedLinkError: Unable to load native library "/data/app/~~0cxWIprct-rKy7Vggu9E4g==/me.nikl.bevygame-YTVT_qxOwHzm_kGsGV9cYw==/lib/arm64/libmobile.so": dlopen failed: library "libc++_shared.so" not found
```
*The helpful line among hundreds of unhelpful ones.*

Opening the APK as an archive indeed shows that `lib/arm64-v8a/` does not include `libc++_shared.so`, while an APK built with cargo-apk includes it. This library is required for audio support in Bevy. I probably could have just ripped out audio for now and moved on, but who am I kidding? I want audio!

Telling gradle to include `libc++_shared.so` turned out to be more complicated than I had thought. Usually, it should realize on its own that the library is needed and include it. The problem is, that we are not using gradle to build the game library, but cargo. So gradle has no way of knowing that we need `libc++_shared.so`. In the end, I gave up on a "clean" solution and went with a hack. I basically [told gradle that the project includes a c++ library][xbuild-hack-libc-shared] which requires the shared library. The c++ project is empty, but it does the trick and creates minimal bloat (~4kB).

With this change, the `UnsatisfiedLinkError` from above is gone, but the game still doesn't work.

### Include assets

While cargo-apk allows simply configuring an asset directory, xbuild does not jet support that. There is an [open PR to add support for assets][xbuild-assets-pr] to the non-gradle builds, but that only works for APKs[^2].

Since Bevy usually comes with a single `assets` directory in the root of the project, [I told gradle to just include that][xbuild-hack-include-assets] with a hardcoded path from deep inside the target directory. At this point, the build generated by xbuild using gradle runs properly.

### Continuous deployment

The app bundle needs to be signed with jarsigner and can then be uploaded to Google Play Console. Doing this manually for every version is no fun, so I wrote a [GitHub workflow for it][workflow-android].

### Support more Android devices

After uploading an app bundle, we can use the app bundle explorer in the Google Play Console to check bundle exports for different devices. My early bundles contained libraries for 4 different ABIs due to the dummy c++ library and [gradle compiling for all non-deprecated ABIs by default][gradle-abis]. The game, on the other hand, was only compiled for `arm64-v8a`, which was hardcoded in xbuild.

The device list in the app bundle explorer can be filtered by ABI. Out of the 18.919 devices, 8.599 are `arm64-v8a` and 10.096 `armeabi-v7a`. Most of the other couple hundred devices are `x86` or `x86_64`[^3]. I went back to xbuild, [fixed the support for `arm` in gradle builds and told it to always build for `arm64` and `arm` when making a build with the `bash$--store` option][xbuild-fix-arm].

The bundle still contains lib directories for `x86` and `x86_64` due to the "dummy cpp lib" workaround. Those lib directories tell the play store that our app bundle can generate APKs for those ABIs which is not correct since we do not build our game for them. A [small gradle configuration][xbuild-no-x86] tells it to not build the dummy library for the `x86(64)` ABIs.


## iOS

I don't own a Mac or iPhone, but still want to support iOS. So I borrowed a Mac for a couple of days to get everything set up in `bevy_game_template`.

The first time I tried to let Xcode publish the app with the copied setup from the Bevy mobile example, the process ended in a list of errors from the App Store. The required changes boiled down to adding an app icon and a launch screen.

### Add Icons

The App Store requires apps for iOS 11 or later to include app icons with an asset catalog. I did this following the [developer documentation from Apple][apple-docs-icon] ([icon][template-add-icon] + [name][template-add-icon-name]).

### Adding a launch screen

Our app requires a launch screen. The `Info.plist` from the Bevy mobile example includes an entry for `UILaunchStoryboardName`, but the launch screen itself is not included. I created one in Xcode following a [stack overflow answer][launch-screen-so] that just contains a centered icon.

### Continuous deployment

At this point, Xcode can create app builds and push them to App Store Connect. I spent some time on creating a [GitHub workflow][workflow-ios] to automate the process. The iOS workflow requires a bit more setup than the Android one, but hopefully, I don't need to organize a Mac again anytime soon.

### One issue left...

...the app has no audio on iOS. I have only tested this with `bevy_kira_audio` so far, so `bevy_audio` might be fine. Maybe someone else knows what's going on here?

## Getting ready for a release

Both stores require some setup for the store pages. The app from `bevy_game_template` is not supposed to go live in the app stores, but it would be nice to be able to share a link that allows anyone to install it. For iOS the goal is "external testing" in AppFlight. In Google Play this release type is called "open testing". Both of these programs require the app to go through a review and the store page to be mostly complete.

### Getting screenshots

Screenshots are a big part of finishing the required setup for publishing. Luckily, the last Bevy update came with a very handy screenshot API. Setting the window dimension and adding the below system gives nice screenshots in configurable resolution. 

```rust
fn screenshot_on_spacebar(
    input: Res<Input<KeyCode>>,
    main_window: Query<Entity, With<PrimaryWindow>>,
    mut screenshot_manager: ResMut<ScreenshotManager>,
    mut counter: Local<u32>,
) {
    if input.just_pressed(KeyCode::Space) {
        let path = format!("./screenshot-{}.png", *counter);
        *counter += 1;
        screenshot_manager
            .save_screenshot_to_disk(main_window.single(), path)
            .unwrap();
    }
}
```
*The system is borrowed from the [Bevy screenshot example][bevy-screenshot-example].*

---

Thank you for reading! If you have any feedback, questions, or comments, you can find me at [@nikl_me@mastodon.online ][mastodon] or on the [Bevy Discord server][bevy_discord] (@nikl).

[^1]: [Crossbow](https://github.com/dodorare/crossbow) might also work, but I didn't manage to set it up correctly. If you do, please tell me.
[^2]: It also doesn't support globs yet, which is a bit unpractical for Bevy's asset directory. Every file and subdirectory would need to be listed separately. I added [simple glob support for APK builds][xbuild-fork-support-globs] on my fork and will try to upstream that once basic assets support has landed.
[^3]: Now I understand why the Bevy mobile example has the [two `arm` targets configured](https://github.com/bevyengine/bevy/blob/v0.11.0/examples/mobile/Cargo.toml#L23) for cargo-apk builds :D

[bevy]: https://bevyengine.org/
[mastodon]: https://mastodon.online/@nikl_me
[bevy_discord]: https://discord.gg/bevy
[app-bundles-only]: https://android-developers.googleblog.com/2021/06/the-future-of-android-app-bundles-is.html
[xbuild]: https://github.com/rust-mobile/xbuild
[xbuild-fork]: https://github.com/NiklasEi/xbuild
[xbuild-fork-support-globs]: https://github.com/rust-mobile/xbuild/commit/ba8d23a955723fe758ee0d1db49c872292c32e57
[xbuild-hack-libc-shared]: https://github.com/NiklasEi/xbuild/commit/a32cdc4300023c81586748b6d8cc9bef6c5e8155
[xbuild-hack-include-assets]: https://github.com/NiklasEi/xbuild/commit/a32cdc4300023c81586748b6d8cc9bef6c5e8155#diff-6279764828c50df7615545319f05789a4a73bd72f620f9c6033e7d8d712df8c0R101
[xbuild-assets-pr]: https://github.com/rust-mobile/xbuild/pull/122
[xbuild-fix-arm]: https://github.com/NiklasEi/xbuild/commit/57dacffc8e146e2d3cf7ada24eb90f3865fae568
[xbuild-no-x86]: https://github.com/NiklasEi/xbuild/commit/deddb185d5a8eaf120fff0a144dd4c18156aeecf
[abi-wiki]: https://en.wikipedia.org/wiki/Application_binary_interface
[workflow-android]: https://www.nikl.me/blog/2023/github_workflow_to_publish_android_app/
[workflow-ios]: https://www.nikl.me/blog/2023/github_workflow_to_publish_ios_app/
[bevy-mobile-1]: https://www.nikl.me/blog/2023/notes_on_android_development_using_bevy/
[gradle-abis]: https://developer.android.com/ndk/guides/abis?hl=en#gradle
[launch-screen-so]: https://stackoverflow.com/a/57201089
[apple-docs-icon]: https://developer.apple.com/documentation/xcode/configuring-your-app-icon
[template-add-icon]: https://github.com/NiklasEi/bevy_game_template/pull/61/commits/cf89f657ceeed5b244ac6db482f584be8310a27c
[template-add-icon-name]: https://github.com/NiklasEi/bevy_game_template/pull/61/commits/e70601eab140c3d18973d8138999dceed781eedb
[template-add-launch-screen]: https://github.com/NiklasEi/bevy_game_template/pull/61/commits/4c982c2e4061b2de807f90bd77041065cc5c0a97
[bevy-screenshot-example]: https://github.com/bevyengine/bevy/blob/main/examples/window/screenshot.rs
[bevy_game_template]: https://github.com/NiklasEi/bevy_game_template
[mobile_example]: https://github.com/bevyengine/bevy/tree/main/examples/mobile
